<!doctype html>
<html lang="fr" class="dark">
    <head>
        <meta charset="UTF-8" />
        <title>OMG Monitor</title>
        <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />

        <script src="https://cdn.tailwindcss.com"></script>

        <script src="/socket.io/socket.io.js"></script>
        <script src="https://unpkg.com/@phosphor-icons/web"></script>

        <script>
            tailwind.config = {
                darkMode: 'class',
                theme: {
                    extend: {
                        colors: {
                            bg: '#0f1115',
                            panel: '#1a1c23',
                            neon: { blue: '#00f3ff', pink: '#ff00ff', green: '#00ff9f', red: '#ff3131' }
                        }
                    }
                }
            };
        </script>
        <style>
            ::-webkit-scrollbar {
                width: 6px;
            }
            ::-webkit-scrollbar-thumb {
                background: #334155;
                border-radius: 99px;
            }

            details > summary {
                list-style: none;
            }
            details > summary::-webkit-details-marker {
                display: none;
            }

            .log-enter {
                animation: slideIn 0.3s ease-out;
            }
            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateX(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            /* Animation Lightbox */
            #custom-lightbox.open {
                display: flex;
                animation: fadeIn 0.2s ease-out forwards;
            }
            #custom-lightbox.open img {
                animation: zoomIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }
            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }
            @keyframes zoomIn {
                from {
                    transform: scale(0.9);
                    opacity: 0;
                }
                to {
                    transform: scale(1);
                    opacity: 1;
                }
            }
        </style>
    </head>
    <body class="bg-bg text-slate-300 font-sans h-screen flex overflow-hidden">
        <aside class="hidden md:flex w-64 flex-col bg-[#0b0c10] border-r border-white/5 z-20">
            <div class="p-6 flex flex-col items-center border-b border-white/5 relative">
                <h1 class="text-xl font-bold text-white">OMG <span class="text-neon-blue">MONITOR</span></h1>
                <div class="mt-2 flex items-center gap-2 px-3 py-1 rounded-full bg-white/5 border border-white/10 text-[10px] text-emerald-400 font-mono">
                    <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>
                    ONLINE
                </div>
            </div>
            <nav class="flex-1 p-4 space-y-4">
                <button onclick="openKeywordModal()" class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium text-slate-300 rounded hover:bg-white/5 hover:text-neon-blue transition border border-transparent hover:border-neon-blue/20"><i class="ph ph-list-dashes text-lg"></i> Mots-clés</button>
                <div class="bg-white/5 p-3 rounded border border-white/5">
                    <div class="text-2xl font-mono text-white font-bold" id="release-count">0</div>
                    <div class="text-[10px] text-slate-500 uppercase">Releases</div>
                </div>
            </nav>
        </aside>

        <main class="flex-1 flex flex-col relative min-w-0 bg-bg">
            <header class="h-16 border-b border-white/5 bg-[#0b0c10]/90 backdrop-blur flex items-center justify-between px-6 shrink-0 sticky top-0 z-10">
                <div class="font-bold text-white md:hidden">OMG BOT</div>
                <div class="text-xs font-mono text-slate-500">LOGS PERSISTANTS &bull; TRI INVERSÉ</div>
                <button onclick="clearDisplay()" class="text-xs border border-white/10 hover:bg-white/5 px-3 py-1 rounded text-slate-400 hover:text-white transition">CLEAR</button>
            </header>

            <div id="feed-container" class="flex-1 overflow-y-auto p-4 space-y-2 scroll-smooth"></div>
        </main>

        <div id="custom-lightbox" class="fixed inset-0 z-[100] bg-black/90 hidden items-center justify-center p-4 backdrop-blur-sm" onclick="closeLightbox()">
            <div class="relative max-w-[90vw] max-h-[90vh] flex flex-col items-center" onclick="event.stopPropagation()">
                <button onclick="closeLightbox()" class="absolute -top-10 right-0 text-slate-400 hover:text-white transition p-2">
                    <i class="ph ph-x text-2xl"></i>
                </button>

                <img id="lb-image" src="" class="max-w-full max-h-[85vh] rounded shadow-2xl border border-white/10 object-contain bg-black" />

                <div class="mt-3 text-center">
                    <div id="lb-caption" class="text-white font-mono text-sm font-bold tracking-wide"></div>
                    <div class="text-[10px] text-slate-500 mt-1">Image 1 of 1</div>
                </div>
            </div>
        </div>

        <div id="keyword-modal" class="fixed inset-0 z-50 bg-black/80 backdrop-blur hidden items-center justify-center transition-opacity opacity-0">
            <div class="w-full max-w-lg bg-[#13151b] rounded-xl border border-white/10 shadow-2xl p-6 transform scale-95 transition-transform" id="kw-content">
                <h3 class="text-lg font-bold text-white mb-4">Éditer Mots-clés</h3>
                <textarea id="keywords-input" class="w-full h-64 bg-[#0a0b0e] border border-white/10 rounded p-3 text-sm font-mono text-slate-300 outline-none focus:border-neon-blue"></textarea>
                <div class="mt-4 flex justify-end gap-3">
                    <button onclick="closeKeywordModal()" class="px-4 py-2 text-sm text-slate-400 hover:text-white">Annuler</button>
                    <button onclick="saveKeywords()" class="px-4 py-2 bg-neon-blue/10 text-neon-blue border border-neon-blue/20 hover:bg-neon-blue/20 rounded text-sm font-bold">Enregistrer</button>
                </div>
            </div>
        </div>

        <script>
            const socket = io();
            const feedContainer = document.getElementById('feed-container');
            const countDisplay = document.getElementById('release-count');
            let releases = {};

            socket.on('history', (history) => {
                feedContainer.innerHTML = '';
                releases = {};
                history.forEach(processLog);
            });

            socket.on('log', (data) => {
                processLog(data);
            });

            function processLog(data) {
                const releaseName = extractReleaseName(data.message);

                if (releaseName) {
                    let el = document.getElementById(`rel-${sanitizeId(releaseName)}`);

                    if (!el) {
                        el = createReleaseRow(releaseName, data.timestamp);
                        feedContainer.prepend(el); // Plus récent en haut
                        countDisplay.innerText = document.querySelectorAll('details.release-row').length;
                    }
                    appendLogToRow(el, data);
                } else {
                    console.log('Log orphelin:', data.message);
                }
            }

            function createReleaseRow(name, time) {
                const safeName = sanitizeId(name);
                const details = document.createElement('details');
                details.id = `rel-${safeName}`;
                details.className = 'release-row group bg-[#13151b] border border-white/5 rounded-lg overflow-hidden transition-colors hover:border-white/10 log-enter';

                // URL Image avec cache busting
                const imgUrl = `/covers/${name}.jpg?t=${Date.now()}`;

                details.innerHTML = `
                <summary class="flex items-center justify-between p-3 cursor-pointer bg-white/[0.02] hover:bg-white/[0.05] select-none">
                    <div class="flex items-center gap-3 overflow-hidden w-full">
                        <div class="text-neon-blue bg-neon-blue/10 p-1.5 rounded transition-transform group-open:rotate-90 shrink-0">
                            <i class="ph ph-caret-right font-bold"></i>
                        </div>
                        
                        <div class="flex flex-col min-w-0 w-full pr-2">
                            <span class="font-bold text-sm text-slate-200 truncate break-all">${name}</span>
                            
                            <div class="flex items-center gap-3 mt-1">
                                <span class="text-[10px] font-mono text-slate-500">${time}</span>
                                
                                <button 
                                   onclick="openLightbox('${imgUrl}', '${name}', event)" 
                                   class="flex items-center gap-1 px-1.5 py-0.5 rounded border border-white/10 bg-white/5 hover:bg-neon-blue/10 hover:text-neon-blue hover:border-neon-blue/30 text-[10px] text-slate-400 transition cursor-pointer z-10 group-btn">
                                    <i class="ph ph-image"></i> Cover
                                </button>
                            </div>
                        </div>
                    </div>
                </summary>
                
                <div class="p-3 bg-[#0a0b0e] border-t border-white/5 text-xs font-mono space-y-1 max-h-60 overflow-y-auto logs-container">
                    </div>
            `;
                return details;
            }

            function appendLogToRow(el, data) {
                const container = el.querySelector('.logs-container');
                const row = document.createElement('div');

                let color = 'text-slate-400';
                if (data.type === 'success') color = 'text-emerald-400';
                if (data.type === 'warning') color = 'text-amber-400';
                if (data.type === 'error') color = 'text-rose-400';

                row.className = 'flex gap-2 border-l-2 border-white/5 pl-2 hover:bg-white/5 py-0.5 rounded-r';
                row.innerHTML = `
                <span class="text-slate-600 shrink-0 select-none">[${data.timestamp}]</span>
                <span class="${color} break-all">${formatMessage(data.message)}</span>
            `;
                container.appendChild(row);
                container.scrollTop = container.scrollHeight;
            }

            // --- Custom Lightbox Logic ---
            const lightboxEl = document.getElementById('custom-lightbox');
            const lbImage = document.getElementById('lb-image');
            const lbCaption = document.getElementById('lb-caption');

            window.openLightbox = (url, caption, e) => {
                // EMPÊCHE la fermeture du details (row)
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                lbImage.src = url;
                lbCaption.innerText = caption;

                // Affichage avec animation
                lightboxEl.classList.remove('hidden');
                // Petit délai pour permettre à la classe CSS d'appliquer l'anim
                requestAnimationFrame(() => {
                    lightboxEl.classList.add('open');
                });
            };

            window.closeLightbox = () => {
                lightboxEl.classList.remove('open');
                setTimeout(() => {
                    lightboxEl.classList.add('hidden');
                    lbImage.src = ''; // Reset pour éviter flash image précédente
                }, 200);
            };

            // Fermeture sur touche Echap
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeLightbox();
            });

            // --- Helpers ---
            function extractReleaseName(msg) {
                if (!msg) return null;
                let m = msg.match(/Release détectée:\s*(.*)/i);
                if (m) return m[1].trim();
                m = msg.match(/Traitement démarré pour:\s*(.*?)(\s\[.*\])?$/i);
                if (m) return m[1].trim();
                m = msg.match(/[\/\\]([^\/\\]+)\.(jpg|nzb|nzb\.gz)$/i);
                if (m) return m[1].trim();
                return null;
            }

            function sanitizeId(str) {
                return str.replace(/[^a-zA-Z0-9\-_]/g, '_');
            }

            function formatMessage(msg) {
                return msg.replace(/(https?:\/\/[^\s]+)/g, '<span class="text-indigo-400 underline">$1</span>');
            }

            function clearDisplay() {
                feedContainer.innerHTML = '';
                countDisplay.innerText = '0';
            }

            // --- Keywords Modal ---
            const kwModal = document.getElementById('keyword-modal');
            const kwContent = document.getElementById('kw-content');
            const kwInput = document.getElementById('keywords-input');

            window.openKeywordModal = async () => {
                kwModal.classList.remove('hidden');
                setTimeout(() => kwModal.classList.remove('opacity-0'), 10);
                kwContent.classList.remove('scale-95');
                kwContent.classList.add('scale-100');

                const res = await fetch('/api/keywords');
                const list = await res.json();
                kwInput.value = list.join('\n');
            };

            window.closeKeywordModal = () => {
                kwModal.classList.add('opacity-0');
                kwContent.classList.remove('scale-100');
                kwContent.classList.add('scale-95');
                setTimeout(() => kwModal.classList.add('hidden'), 200);
            };

            window.saveKeywords = async () => {
                const list = kwInput.value
                    .split('\n')
                    .map((s) => s.trim())
                    .filter((s) => s);
                await fetch('/api/keywords', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(list)
                });
                closeKeywordModal();
            };
        </script>
    </body>
</html>
